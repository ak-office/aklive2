<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Player</title>
  <!-- Plyr CSS -->
  <link href="https://cdn.plyr.io/3.7.8/plyr.css" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden; /* Prevent scrollbars */
    }
    video {
      width: 100vw;
      height: 100vh;
      object-fit: contain; /* Ensure video fits without cropping */
      display: block;
    }
    .video-description {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      color: #fff;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10; /* Above video but below controls */
      max-width: 90%;
      text-align: center;
    }
    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ff5555;
      font-size: 18px;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 20; /* Above all elements */
      text-align: center;
      max-width: 90%;
    }
    :root {
      --plyr-color-main: #949602; /* Custom Plyr theme color */
    }
  </style>
</head>
<body>
  <!-- Video element directly in body -->
  <video id="video-player" controls playsinline></video>

  <!-- Hls.js and Plyr JS -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15"></script>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script>
    // Prompt user to join Telegram channel (non-blocking)
    setTimeout(() => {
      if (confirm("Join our Telegram Channel @AK_LIVE_OFFICE?")) {
        window.location.href = "https://t.me/AK_LIVE_OFFICE";
      }
    }, 1000);

    // Check for required URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.has("id")) {
      document.title = "Error: Missing ID";
      showError("Missing required ID parameter");
      throw new Error("Missing required parameter");
    }

    // Fetch media playlist from API
    async function fetchPlaylist() {
      try {
        const response = await fetch("https://pb.oii.im/~aklive");
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error("Fetch error:", error);
        showError("Failed to load playlist. Please try again later.");
        return [];
      }
    }

    // Get ID from URL parameters
    function getStreamId() {
      return urlParams.get("id");
    }

    // Display error message in the UI
    function showError(message) {
      const existingError = document.querySelector(".error-message");
      if (existingError) existingError.remove(); // Remove previous errors
      const errorDiv = document.createElement("div");
      errorDiv.className = "error-message";
      errorDiv.textContent = message;
      document.body.appendChild(errorDiv);
    }

    // Update quality selection
    function updateQuality(newQuality, hls) {
      if (newQuality === 0) {
        hls.currentLevel = -1; // Enable auto quality
        console.log("Switched to Auto");
      } else {
        hls.levels.forEach((level, levelIndex) => {
          if (level.height === newQuality) {
            console.log(`Switching to quality: ${newQuality}p`);
            hls.currentLevel = levelIndex;
          }
        });
      }
    }

    // Set up player
    document.addEventListener("DOMContentLoaded", async () => {
      const video = document.getElementById("video-player");

      // Fetch playlist and find stream
      const playlist = await fetchPlaylist();
      const streamId = getStreamId();
      const stream = playlist.find(item => item.id === streamId);

      if (!stream) {
        console.error("Stream not found");
        showError("Stream not found. Please check the ID or try again.");
        return;
      }

      // Set document title and metadata
      document.title = stream.title || "Video Player";
      if (stream.poster) {
        video.setAttribute("poster", stream.poster);
      }

      // Add subtitles if provided
      if (stream.subtitles && Array.isArray(stream.subtitles)) {
        stream.subtitles.forEach(sub => {
          const track = document.createElement("track");
          track.kind = sub.kind || "subtitles";
          track.src = sub.src || sub.file; // Support src or file
          track.label = sub.label || "Unnamed";
          track.srclang = sub.lang || sub.srclang || "en";
          if (sub.default) {
            track.default = true;
          }
          video.appendChild(track);
        });
      }

      // Display description if provided
      if (stream.description) {
        const descElement = document.createElement("div");
        descElement.className = "video-description";
        descElement.textContent = stream.description;
        document.body.appendChild(descElement);
      }

      // Default Plyr options
      const defaultOptions = {
        controls: stream.controls || [
          "play-large",
          "play",
          "progress",
          "current-time",
          "mute",
          "volume",
          "captions",
          "settings",
          "pip", // Added Picture-in-Picture
          "fullscreen"
        ],
        settings: stream.subtitles?.length > 0 ? ["quality", "captions", "speed", "loop"] : ["quality", "speed", "loop"],
        captions: { active: stream.subtitles?.length > 0, language: stream.subtitles?.[0]?.lang || stream.subtitles?.[0]?.srclang || "auto" }
      };

      if (!Hls.isSupported()) {
        // Fallback for non-HLS support
        const sourceElement = document.createElement("source");
        sourceElement.src = stream.url;
        video.appendChild(sourceElement);
        const player = new Plyr(video, defaultOptions);
        // Enable PiP manually if supported
        if (document.pictureInPictureEnabled) {
          player.on("ready", () => {
            const pipButton = document.querySelector(".plyr__control[data-plyr='pip']");
            if (pipButton) {
              pipButton.addEventListener("click", () => {
                if (!document.pictureInPictureElement) {
                  video.requestPictureInPicture().catch(err => console.error("PiP error:", err));
                } else {
                  document.exitPictureInPicture().catch(err => console.error("Exit PiP error:", err));
                }
              });
            }
          });
        }
      } else {
        // Initialize HLS.js with custom header
        const hls = new Hls({
          xhrSetup: (xhr) => {
            xhr.setRequestHeader("x-token-platform", "web");
          }
        });

        hls.loadSource(stream.url);

        // Handle manifest parsing
        hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
          const availableQualities = hls.levels.map(l => l.height).filter(h => h);
          availableQualities.unshift(0); // Add 0 for Auto

          // Configure Plyr quality options
          defaultOptions.quality = {
            default: 0, // Auto by default
            options: availableQualities,
            forced: true,
            onChange: (newQuality) => updateQuality(newQuality, hls)
          };

          // Add Auto label
          defaultOptions.i18n = {
            qualityLabel: {
              0: "Auto",
              ...hls.levels.reduce((acc, l) => {
                if (l.height) acc[l.height] = `${l.height}p`;
                return acc;
              }, {})
            }
          };

          // Update Auto label during quality switches
          hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
            const span = document.querySelector(".plyr__menu__container [data-plyr='quality'][value='0'] span");
            if (span) {
              if (hls.autoLevelEnabled && hls.levels[data.level]?.height) {
                span.innerHTML = `Auto (${hls.levels[data.level].height}p)`;
              } else {
                span.innerHTML = "Auto";
              }
            }
          });

          // Initialize Plyr
          const player = new Plyr(video, defaultOptions);
          // Ensure PiP button works
          if (document.pictureInPictureEnabled) {
            player.on("ready", () => {
              const pipButton = document.querySelector(".plyr__control[data-plyr='pip']");
              if (pipButton) {
                pipButton.addEventListener("click", () => {
                  if (!document.pictureInPictureElement) {
                    video.requestPictureInPicture().catch(err => console.error("PiP error:", err));
                  } else {
                    document.exitPictureInPicture().catch(err => console.error("Exit PiP error:", err));
                  }
                });
              }
            });
          }
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            console.error("HLS error:", data);
            showError("Failed to load stream. Please check your connection or try again.");
          }
        });

        hls.attachMedia(video);
        window.hls = hls; // Expose for debugging
      }
    });
  </script>
</body>
</html>
